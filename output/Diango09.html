<!DOCTYPE html>
<html lang="zh_cn">
<head>
	<title>Django--09ORM操作 | ge_ren_bo_ke</title>
	<meta charset="utf-8" />
    <meta name="author" content="chen_meng_xu">
	<link rel="stylesheet" href="/theme/css/franticworld.css" type="text/css" />
	<link href="/theme/css/pygments.css" rel="stylesheet">
</head>
<body background="/theme/img/pattern.png">
		<div class="nav-banner">
		<a href="">ge_ren_bo_ke</a>
		</div>
		
		<div class="content">

<div class="metabox">
	<p class="metayear">小旭</p>
	<p class="metaday">♥</p>
	<p class="metayear">小雪</p>
	<p class="metacategory">一辈子</p>
</div>
<div class="arcticlecontentbox">
	<div class="articlecontent">
		<a class="articletitle" href="/Diango09.html " >Django--09ORM操作</a>
		<h3>Django模型之ORM操作</h3>
<h4>ORM介绍</h4>
<ul>
<li><strong>什么是ORM</strong>
  ORM 全拼Object-Relation Mapping.</li>
</ul>
<p>中文意为 对象-关系映射.</p>
<p>在MVC/MVT设计模式中的Model模块中都包括ORM</p>
<ul>
<li>
<p><strong>ORM优势</strong></p>
</li>
<li>
<p>只需要面向对象编程, 不需要面向数据库编写代码.</p>
<p>对数据库的操作都转化成对类属性和方法的操作.
不用编写各种数据库的sql语句.</p>
</li>
<li>
<p>实现了数据模型与数据库的解耦, 屏蔽了不同数据库操作上的差异.</p>
<p>不在关注用的是mysql、oracle...等.
通过简单的配置就可以轻松更换数据库, 而不需要修改代码.</p>
</li>
<li>
<p><strong>ORM劣势</strong>
  相比较直接使用SQL语句操作数据库,有性能损失.
  根据对象的操作转换成SQL语句,根据查询的结果转化成对象, 在映射过程中有性能损失.</p>
</li>
<li>
<p><strong>ORM和数据库关系：</strong>
  在Django中model是你数据的单一、明确的信息来源。它包含了你存储的数据的重要字段和行为。通常，一个模型（model）映射到一个数据库表.</p>
</li>
</ul>
<p>基本情况：</p>
<p>每个模型都是一个Python类，它是django.db.models.Model的子类。</p>
<p>模型的每个属性都代表一个数据库字段。</p>
<h4>ORM操作</h4>
<p><strong>增加操作</strong></p>
<div class="highlight"><pre><span></span><span class="c1"># 通过python manage.py shell 进入到shell下</span>
<span class="c1"># 进入shell环境以后，首先导入模型</span>
<span class="kn">from</span> <span class="nn">polls.models</span> <span class="kn">import</span> <span class="o">*</span>          <span class="c1"># 导入全部模型</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>   <span class="c1"># 导入时间模块</span>
<span class="c1"># 创建方法一：</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">Question</span><span class="p">(</span><span class="n">question_text</span><span class="o">=</span><span class="s2">&quot;什么地方的菜最有特色？&quot;</span><span class="p">,</span> <span class="n">pub_date</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<span class="n">q</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c1"># 关联创建，用问题关联创建选项</span>
<span class="n">q</span><span class="o">.</span><span class="n">choice_set</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">choice_text</span><span class="o">=</span><span class="s2">&quot;湖南&quot;</span><span class="p">)</span>


<span class="c1"># 创建方法二：</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">Question</span><span class="p">()</span>          <span class="c1"># 创建实例对象</span>
<span class="n">q</span><span class="o">.</span><span class="n">question_text</span> <span class="o">=</span> <span class="s2">&quot;什么地方的菜最有特色？&quot;</span>
<span class="n">q</span><span class="o">.</span><span class="n">pub_date</span> <span class="o">=</span> <span class="n">timeaone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">q</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c1"># 创建方法三：</span>
<span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">question_text</span><span class="o">=</span><span class="s2">&quot;什么地方的菜最有特色？&quot;</span><span class="p">,</span> 
                        <span class="n">pub_date</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>


<span class="c1"># 批量创建，可以提高性能，减少对数据库的访问写入次数</span>
<span class="n">bulk_create</span><span class="p">()</span>

<span class="c1"># 批量添加，需要传入的参数是一个列表</span>
<span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">Question</span><span class="p">(</span><span class="n">question_text</span><span class="o">=</span><span class="s2">&quot;什么地方的菜最有特色？&quot;</span><span class="p">,</span> <span class="n">pub_date</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()),</span>
        <span class="n">Question</span><span class="p">(</span><span class="n">question_text</span><span class="o">=</span><span class="s2">&quot;什么地方的景色最美？&quot;</span><span class="p">,</span> <span class="n">pub_date</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="err">，</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>


<h4>修改操作</h4>
<div class="highlight"><pre><span></span><span class="c1"># 修改方法1：</span>
<span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">question_text</span> <span class="o">=</span> <span class="s2">&quot;什么地方最好玩？&quot;</span><span class="p">)</span>  

<span class="c1"># 修改方法2：</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
<span class="n">q</span><span class="o">.</span><span class="n">question</span> <span class="o">=</span> <span class="s2">&quot;什么地方最好玩？&quot;</span>
<span class="n">q</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<h4>删除操作</h4>
<div class="highlight"><pre><span></span><span class="c1"># 删除：(先查询到某个queryset对象，然后用删除命令)</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">q</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>


<h4>查询操作</h4>
<p><strong>必会的方法</strong></p>
<div class="highlight"><pre><span></span><span class="c1"># 1、 all():                 查询所有结果</span>
<span class="n">question_list</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># 返回一个queryset集合</span>

<span class="c1"># 2、 filter(**kwargs):      它包含了与所给筛选条件相匹配的对象</span>
<span class="n">question_list</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 返回一个queryset集合,如果没有查询到，返回一个空集合,不会报错</span>

<span class="c1"># 3、 get(**kwargs):         返回与所给筛选条件相匹配的对象，返回结果有且只有一个，如果符合筛选条件的                              对象超过一个或者没有都会抛出错误。</span>
<span class="n">question</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 返回一个queryset对象，并且只会得到一个数据，如果没有查询到，会报DoesNotExist的错误</span>

<span class="c1"># 4、 exclude(**kwargs):     它包含了与所给筛选条件不匹配的对象</span>
<span class="n">question</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">33</span><span class="p">])</span>  <span class="c1"># 筛选id除了11，22，33外的，其它的数据</span>

<span class="c1"># 5、 values(*field):        返回一个ValueQuerySet——一个特殊的QuerySet，运行后得到的并不是一系列                              model的实例化对象，而是一个可迭代的字典序列</span>
<span class="n">question</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
<span class="c1"># 返回结果：[{&quot;id&quot;: 1, &quot;question_name&quot;: &quot;xxxxxxx&quot;}, {&quot;id&quot;: 2, &quot;question_name&quot;: &quot;xxxxxxx&quot;}, ...]</span>

<span class="c1"># 6、 values_list(*field):   它与values()非常相似，它返回的是一个元组序列，values返回的是一个字典序                             列</span>
<span class="n">question</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values_list</span><span class="p">()</span>
<span class="c1"># 返回结果：[(1, &quot;xxxxxxx&quot;), (2, &quot;xxxxxxx&quot;), ....]</span>

<span class="c1"># 7、 order_by(*field):      对查询结果排序</span>
<span class="n">user_list</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-id&quot;</span><span class="p">)</span>  <span class="c1"># “-” 按id降序排列</span>
<span class="n">user_list</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span>  <span class="c1"># 按id升序排列（默认）</span>

<span class="c1"># 8、 reverse():             对查询结果反向排序，请注意reverse()通常只能在具有已定义顺序的QuerySet                             上调用(在model类的Meta中指定ordering或调用order_by()方法)。</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>  <span class="c1"># 把查询的结果进行反转</span>

<span class="c1"># 9、 distinct():            从返回结果中剔除重复纪录(如果你查询跨越多个表，可能在计算QuerySet时得到                             重复的结果。此时可以使用distinct()，注意只有在PostgreSQL中支持按字段                             去重。)</span>
<span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>  <span class="c1"># 把结果中重复的记录剔除</span>

<span class="c1"># 10、 count():              返回数据库中匹配查询(QuerySet)的对象数量。</span>
<span class="n">user_count</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>  <span class="c1"># 返回user表中的用户数量</span>

<span class="c1"># 11、 first():              返回第一条记录</span>
<span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

<span class="c1"># 12、 last():               返回最后一条记录</span>
<span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>    

<span class="c1"># 13、 exists():             如果QuerySet包含数据，就返回True，否则返回False</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>  <span class="c1"># 返回True 或者False</span>
<span class="k">if</span> <span class="n">user</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">)</span>
</pre></div>


<h3>查询条件</h3>
<p><strong>在 ORM 层面，这些查询条件都是使用 field + __ + condition 的方式来使用</strong></p>
<div class="highlight"><pre><span></span><span class="c1"># 精确的 等于,如果提供一个None,SQL解析为Null</span>
<span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id__exact</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id__exact</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">对应sql</span>
<span class="sd">select ... from article where id=14;</span>
<span class="sd">select ... from article where id IS NULL;</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1"># iexact 使用like查询</span>
<span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title__iexact</span><span class="o">=</span><span class="s1">&#39;hello world&#39;</span><span class="p">)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">等价于 select ... from article where title like &#39;hello world&#39;</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1"># 包含:contains,区分大小写</span>
<span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title__contains</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">等价于select ... where title like binary &#39;%hello%&#39;;</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1"># icontains 忽略大小写</span>
<span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title__icontains</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">等价于 select ... where title like &#39;%hello%&#39;;</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1"># in 提取那些给定的field的值是否在给定的容器中。容器可以为list、tuple或者任何一个可以迭代的对</span>
<span class="err">象，</span><span class="c1"># 包括QuerySet对象</span>
<span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">等价于 select ... where id in (1,3,4)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1"># 当然也可以传递一个QuerySet对象进去。示例代码如下：</span>
<span class="n">inner_qs</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title__contains</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="n">categories</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">article__in</span><span class="o">=</span><span class="n">inner_qs</span><span class="p">)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">等价于:以上代码的意思是获取那些文章标题包含hello的所有分类。</span>
<span class="sd">select ...from category where article.id in (select id from article where title</span>
<span class="sd">like &#39;%hello%&#39;);</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1"># gt 大于</span>
<span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__gt</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">等价于 select ... where id &gt; 4;</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1"># gte 大于等于</span>
<span class="c1"># lt 小于</span>
<span class="c1"># lte 小于等于</span>
<span class="c1"># startswidth 开始,大小写敏感</span>
<span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title__startswith</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">等价于: select ... where title like &#39;hello%&#39;</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1"># istartswidth 大小写不敏感</span>
<span class="c1"># endswidth 以**结尾,大小写敏感</span>
<span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title__endswith</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="p">)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">等价于:select ... where title like &#39;%world&#39;;</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1"># iendswidht 以**结尾,忽略大小写</span>
<span class="c1"># range 判断某个field的值是否在给定的区间中, 两个范围之间</span>
<span class="kn">from</span> <span class="nn">django.utils.timezone</span> <span class="kn">import</span> <span class="n">make_aware</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="n">make_aware</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2018</span><span class="p">,</span><span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="n">make_aware</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2018</span><span class="p">,</span><span class="n">month</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">day</span><span class="o">=</span><span class="mi">29</span><span class="p">,</span><span class="n">hour</span><span class="o">=</span><span class="mi">16</span><span class="p">))</span>
<span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pub_date__range</span><span class="o">=</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span><span class="n">end_date</span><span class="p">))</span>
<span class="c1"># isnull</span>
<span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pub_date__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="c1"># regex和iregex： 正则</span>
<span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title__regex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^hello&#39;</span><span class="p">)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">等价:select ... where title regexp binary &#39;^hello&#39;;</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">以上代码的意思是提取所有发布时间在2018/1/1到2018/12/12之间的文章。</span>
<span class="sd">将翻译成以下的SQL语句：</span>
<span class="sd">select ... from article where pub_time between &#39;2018-01-01&#39; and &#39;2018-12-12&#39;。</span>
<span class="sd">需要注意的是，以上提取数据，不会包含最后一个值。也就是不会包含2018/12/12的文章。</span>
<span class="sd">而且另外一个重点，因为我们在settings.py中指定了USE_TZ=True，并且设置了</span>
<span class="sd">TIME_ZONE=&#39;Asia/Shanghai&#39;，因此我们在提取数据的时候要使用django.utils.timezone.make_aware</span>
<span class="sd">先将datetime.datetime从navie时间转换为aware时间。make_aware会将指定的时间转换为TIME_ZONE中</span>
<span class="sd">指定的时区的时间。</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>


<h3>根据关联的表查</h3>
<p><strong>假如现在有两个 ORM 模型，一个是 Article ，一个是 Category 。代码如下：</strong></p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;文章分类表&quot;&quot;&quot;</span>
  <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;文章表&quot;&quot;&quot;</span>
  <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;Category&quot;</span><span class="p">,</span><span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
</pre></div>


<p><strong>比如想要获取文章标题中包含"hello"的所有的分类。那么可以通过以下代码来实现：</strong></p>
<div class="highlight"><pre><span></span><span class="n">categories</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">article__title__contains</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">))</span> 
</pre></div>


<h3>聚合函数</h3>
<p><strong>聚合函数是通过 aggregate 方法来实现的。</strong></p>
<ul>
<li><strong>Avg ：求平均值。比如想要获取所有图书的价格平均值。那么可以使用以下代码实现</strong></li>
</ul>
<p><code>python
  from django.db.models import Avg
  result = Book.objects.aggregate(Avg('price'))
  print(result)</code></p>
<p>以上的打印结果是：</p>
<p><code>{"price__avg":23.0}</code></p>
<p>其中 price__avg 的结构是根据 field__avg 规则构成的。如果想要修改默认的名字，那么可以将 Avg 赋值
  给一个关键字参数。示例代码如下：</p>
<p><code>python
  from django.db.models import Avg
  result = Book.objects.aggregate(my_avg=Avg('price'))
  print(result)</code></p>
<p>那么以上的结果打印为：</p>
<p><code>python
  {"my_avg":23}</code></p>
<ul>
<li><strong>Count ：获取指定的对象的个数。示例代码如下：</strong></li>
</ul>
<p><code>python
  from django.db.models import Count
  result = Book.objects.aggregate(book_num=Count('id'))</code></p>
<p>以上的 result 将返回 Book 表中总共有多少本图书。  Count 类中，还有另外一个参数叫做 distinct ，默
  认是等于 False ，如果是等于 True ，那么将去掉那些重复的值。比如要获取作者表中所有的不重复的邮箱
  总共有多少个，那么可以通过以下代码来实现：</p>
<p><code>python
  from djang.db.models import Count
  result = Author.objects.aggregate(count=Count('email',distinct=True))</code></p>
<ul>
<li><strong>Max 和 Min ：获取指定对象的最大值和最小值。比如想要获取 Author 表中，最大的年龄和最小的年龄分别</strong>
  <strong>是多少。那么可以通过以下代码来实现：</strong></li>
</ul>
<p><code>python
  from django.db.models import Max,Min
  result = Author.objects.aggregate(Max('age'),Min('age'))</code></p>
<p>如果最大的年龄是88,最小的年龄是18。那么以上的result将为：</p>
<p><code>python
  {"age__max":88,"age__min":18}</code></p>
<ul>
<li><strong>Sum ：求指定对象的总和。比如要求图书的销售总额。那么可以使用以下代码实现：</strong></li>
</ul>
<p><code>python
  from djang.db.models import Sum
  result =
  Book.objects.annotate(total=Sum("bookstore__price")).values("name","total")</code></p>
<p>以上的代码 annotate 的意思是给 Book 表在查询的时候添加一个字段叫做 total ，这个字段的数据来源是
  从 BookStore 模型的 price 的总和而来。 values 方法是只提取 name 和 total 两个字段的值。</p>
<p>更多的聚合函数请参考官方文档：https://docs.djangoproject.com/en/2.0/ref/models/querysets/#aggregation-functions</p>
<h3>aggregate和annotate的区别：</h3>
<ul>
<li>aggregate ：返回使用聚合函数后的字段和值。</li>
<li>annotate ：在原来模型字段的基础之上添加一个使用了聚合函数的字段，并且在使用聚合函数的时候，会
  使用当前这个模型的主键进行分组（group by）。 比如以上 Sum 的例子，如果使用的是 annotate ，那么将
  在每条图书的数据上都添加一个字段叫做 total ，计算这本书的销售总额。 而如果使用的是 aggregate ，
  那么将求所有图书的销售总额。</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;作者模型&quot;&quot;&quot;</span>
  <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
  <span class="n">age</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
  <span class="n">email</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">()</span>
  <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
    <span class="n">db_table</span> <span class="o">=</span> <span class="s1">&#39;author&#39;</span>
<span class="k">class</span> <span class="nc">Publisher</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;出版社模型&quot;&quot;&quot;</span>
  <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
  <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
    <span class="n">db_table</span> <span class="o">=</span> <span class="s1">&#39;publisher&#39;</span>
<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;图书模型&quot;&quot;&quot;</span>
  <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
  <span class="n">pages</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
  <span class="n">price</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
  <span class="n">rating</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
  <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Author</span><span class="p">,</span><span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
  <span class="n">publisher</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Publisher</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
  <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
    <span class="n">db_table</span> <span class="o">=</span> <span class="s1">&#39;book&#39;</span>
<span class="k">class</span> <span class="nc">BookOrder</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;图书订单模型&quot;&quot;&quot;</span>
  <span class="n">book</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;Book&quot;</span><span class="p">,</span><span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
  <span class="n">price</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
  <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
    <span class="n">db_table</span> <span class="o">=</span> <span class="s1">&#39;book_order&#39;</span>
</pre></div>


<h3>F表达式和Q表达式：</h3>
<h4>F表达式：</h4>
<p>F表达式 是用来优化 ORM 操作数据库的。比如我们要将公司所有员工的薪水都增加1000元，如果按照正常的流
程，应该是先从数据库中提取所有的员工工资到Python内存中，然后使用Python代码在员工工资的基础之上增加
1000元，最后再保存到数据库中。这里面涉及的流程就是，首先从数据库中提取数据到Python内存中，然后在
Python内存中做完运算，之后再保存到数据库中。示例代码如下：</p>
<div class="highlight"><pre><span></span><span class="n">employees</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="k">for</span> <span class="n">employee</span> <span class="ow">in</span> <span class="n">employees</span><span class="p">:</span>
  <span class="n">employee</span><span class="o">.</span><span class="n">salary</span> <span class="o">+=</span> <span class="mi">1000</span>
  <span class="n">employee</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<p>而我们的 F表达式 就可以优化这个流程，他可以不需要先把数据从数据库中提取出来，计算完成后再保存回去，他可以直接执行 SQL语句 ，就将员工的工资增加1000元。示例代码如下：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">djang.db.models</span> <span class="kn">import</span> <span class="n">F</span>
<span class="n">Employee</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">salary</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;salary&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1000</span><span class="p">)</span>
<span class="c1"># 直接把sql传输到数据库!!!!!</span>
</pre></div>


<p>F表达式 并不会马上从数据库中获取数据，而是在生成 SQL 语句的时候，动态的获取传给 F表达式 的值。
比如如果想要获取作者中， name 和 email 相同的作者数据。如果不使用 F表达式 ，那么需要使用以下代码来完
成：</p>
<div class="highlight"><pre><span></span><span class="n">authors</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">authors</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">author</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">author</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>
</pre></div>


<p>如果使用 F表达式 ，那么一行代码就可以搞定。示例代码如下：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">F</span>
<span class="n">authors</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">))</span>
<span class="c1"># where  email = name</span>
</pre></div>


<h4>Q表达式：</h4>
<p>如果想要实现所有价格高于100元，并且评分达到9.0以上评分的图书。那么可以通过以下代码来实现：</p>
<div class="highlight"><pre><span></span><span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">price__gte</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">rating__gte</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span> 
</pre></div>


<p>以上这个案例是一个并集查询，可以简单的通过传递多个条件进去来实现。 但是如果想要实现一些复杂的查询语
句，比如要查询所有价格低于10元，或者是评分低于9分的图书。那就没有办法通过传递多个条件进去实现了。这
时候就需要使用 Q表达式 来实现了。示例代码如下：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Q</span>
<span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">price__lte</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">rating__lte</span><span class="o">=</span><span class="mi">9</span><span class="p">))</span>
</pre></div>


<p>以上是进行或运算，当然还可以进行其他的运算，比如有 &amp; 和 ~（非） 等。一些用 Q 表达式的例子如下：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Q</span>
<span class="c1"># 获取id等于3的图书</span>
<span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="c1"># 获取id等于3，或者名字中包含文字&quot;记&quot;的图书</span>
<span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">name__contains</span><span class="p">(</span><span class="s2">&quot;记&quot;</span><span class="p">)))</span>
<span class="c1"># 获取价格大于100，并且书名中包含&quot;记&quot;的图书</span>
<span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">price__gte</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Q</span><span class="p">(</span><span class="n">name__contains</span><span class="p">(</span><span class="s2">&quot;记&quot;</span><span class="p">)))</span>
<span class="c1"># 获取书名包含“记”，但是id不等于3的图书</span>
<span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">name__contains</span><span class="o">=</span><span class="s1">&#39;记&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
</pre></div>


<h3>日期</h3>
<div class="highlight"><pre><span></span><span class="c1"># data</span>
<span class="err">针对某些</span><span class="n">date或者datetime类型的字段</span><span class="err">。可以指定</span><span class="n">date的范围</span><span class="err">。并且这个时间过滤，还可以使用链式调用。示</span>
<span class="err">例代码如下：</span>
<span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pub_date__date</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">29</span><span class="p">))</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">以上代码的意思是查找时间为2018/3/29这一天发表的所有文章。</span>
<span class="sd">将翻译成以下的sql语句：</span>
<span class="sd">select ... WHERE DATE(CONVERT_TZ(`front_article`.`pub_date`, &#39;UTC&#39;,</span>
<span class="sd">&#39;Asia/Shanghai&#39;)) = 2018-03-29</span>
<span class="sd">注意，因为默认情况下MySQL的表中是没有存储时区相关的信息的。因此我们需要下载一些时区表的文件，然后添</span>
<span class="sd">加到Mysql的配置路径中。如果你用的是windows操作系统。那么在</span>
<span class="sd">http://dev.mysql.com/downloads/timezones.html下载timezone_2018d_posix.zip - POSIX</span>
<span class="sd">standard。然后将下载下来的所有文件拷贝到C:\ProgramData\MySQL\MySQL Server 5.7\Data\mysql</span>
<span class="sd">中，如果提示文件名重复，那么选择覆盖即可。</span>
<span class="sd">如果用的是linux或者mac系统，那么在命令行中执行以下命令：mysql_tzinfo_to_sql</span>
<span class="sd">/usr/share/zoneinfo | mysql -D mysql -u root -p，然后输入密码，从系统中加载时区文件更新到</span>
<span class="sd">mysql中。</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1"># year 根据年份进行查找</span>
<span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pub_date__year</span><span class="o">=</span><span class="mi">2018</span><span class="p">)</span>
<span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pub_date__year__gte</span><span class="o">=</span><span class="mi">2017</span><span class="p">)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">等价于:</span>
<span class="sd">select ... where pub_date between &#39;2018-01-01&#39; and &#39;2018-12-31&#39;;</span>
<span class="sd">select ... where pub_date &gt;= &#39;2017-01-01&#39;;</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1"># month 同year,根据月份查</span>
<span class="c1"># day  同year,根据日期查</span>
<span class="c1"># week_day Django 1.11新增的查找方式。同year，根据星期几进行查找。1表示星期天，7表示星期六，2-6代表的是星期一到星期五。</span>
<span class="c1"># time 根据时间查</span>
<span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pub_date__time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">));</span>
<span class="c1"># 以上的代码是获取每一天中12点12分12秒发表的所有文章。</span>
</pre></div>


<p>更多的关于时间的过滤，请参考Django官方文档：
https://docs.djangoproject.com/en/2.0/ref/models/querysets/#range。</p>
	</div>
	
	       
</div>

		</div>
		
		<div class="sidebar">
<div class="sidebarcategory">
<h4>个人简介</h4>
	<li><a href="#"><b>博主：</b>小旭旭</a></li>
	<li><a href="#"><b>生日：</b>2000-07-24</a></li>
	<li><a href="#"><b>性别：</b>公</a></li>
	<li><a href="#"><b>爱人：</b>小雪雪</a></li>
</div>

<div class="sidebarpages">
</div>

<div class="sidebarcategory">
<h4>相关连接</h4>
	<li><a href="https://gitee.com/QiHanXiBei/projects" target="_blank">刘悦git</a></li>
	<li><a href="https://v3u.cn/" target="_blank">刘悦技术博客</a></li>
	<li><a href="https://gitee.com/eastside" target="_blank">Eastsidegit</a></li>
    <li><a href="https://lienze.tech/" target="_blank">老渔夫吃虾米</a></li>
    <li><a href="https://gitee.com/chen_meng-_xu/projects" target="_blank">陈梦旭git</a></li>

</div>

<div class="sidebarcategory">
<h4>热点文档</h4>
    <li><a href="http://localhost:8000/my_tow.html">Django--01简介</a></li>
    <li><a href="http://localhost:8000/my_tow.html">Django--02虚拟环境</a></li>
    <li><a href="http://localhost:8000/my_tow.html">Django--03环境的安装</a></li>
    <li><a href="http://localhost:8000/my_tow.html">Django--04项目创建和应用</a></li>
    <li><a href="http://localhost:8000/my_tow.html">Django--05pep8规范</a></li>
    <li><a href="http://localhost:8000/my_tow.html">Django--06视图与URL映射</a></li>
    <li><a href="http://localhost:8000/my_tow.html">Django--07常用字段</a></li>
    <li><a href="http://localhost:8000/my_tow.html">Django--08Meta常用选项</a></li>
    <li><a href="http://localhost:8000/my_tow.html">Django--0ORM操作</a></li>
    <li><a href="http://localhost:8000/my_tow.html">Django--10Vue解决跨域问题</a></li>

<!---->
</div>		</div>
		
		<footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                磨练， <a href="http://getpelican.com/">使人难以忍受，</a>,
                使人步履维艰， <a href="http://python.org">但它能使强者站得更挺，</a>,
				走得更稳， <a href="http://frantic1048.com/">产生更强的斗志。</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>